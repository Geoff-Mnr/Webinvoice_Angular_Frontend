<div class="px-4 sm:px-6 lg:px-8">
  <div class="sm:flex sm:items-center">
    <div class="sm:flex-auto">
      <h1 class="text-2xl font-semibold font-open leading-6 text-secondaryforeground">Liste des tickets ✨</h1>
    </div>
  </div>
  <div class="mt-8 flow-root">
    @if(tickets.length === 0) {
    <div class="flex justify-center items-center h-32 bg-background">
      <p class="text-secondaryforeground">Aucun ticket trouvé</p>
    </div>
    } @for(ticket of tickets; track tickets; let i = $index){
    <div class="bg-background rounded-sm font-montserrat px-4 py-5 sm:px-6 mt-3">
      <div class="flex space-x-3">
        <div class="flex-shrink-0">
          <img class="h-10 w-10 rounded-full" [src]="ticket.createdBy.profile_picture" alt="" />
        </div>
        <div class="min-w-0 flex-1">
          <p class="text-normal font-semibold text-secondaryforeground">
            {{ ticket.createdBy.username }} - <span class="font-light text-xs">{{ ticket.createdBy.role.name }}</span>
          </p>
          <p class="text-xs text-primary">
            {{ ticket.created_at }}
          </p>
          <div class="mt-4">
            <h3 class="text-md font-semibold font-open text-secondaryforeground">{{ ticket.title }}</h3>
            <p class="text-normal font-light text-secondaryforeground">
              {{ ticket.description }}
            </p>
            <span [ngClass]="getStatusClass(ticket.status, i)">{{ getStatusText(ticket.status, i) }}</span>
          </div>
          <div *ngFor="let user of ticket.users; let i = index" class="flex space-x-3 mt-6">
            <ng-container *ngIf="i !== 0">
              <div class="flex-shrink-0">
                <img class="h-10 w-10 rounded-full" [src]="user.profile_picture" alt="{{ user?.username }}'s Profile Picture" />
              </div>
              <div class="min-w-0 flex-1">
                <p class="text-normal font-semibold text-secondaryforeground">
                  {{ user?.username }} - <span class="font-light text-xs">{{ user?.role_name }}</span>
                </p>
                <p class="text-xs text-primary">
                  {{ user.pivot.created_at }}
                </p>
                <p class="text-normal font-light text-secondaryforeground mt-1">
                  {{ user.pivot.message }}
                </p>
              </div>
            </ng-container>
          </div>
        </div>
        <div class="flex flex-shrink-0">
          <div class="relative inline-block text-left">
            <div>
              <button
                type="button"
                (click)="toggleMenu(i)"
                class="-m-2 flex items-center rounded-full p-2 text-secondaryforeground hover:text-primary"
                id="menu-{{ i }}-button"
                aria-expanded="false"
                aria-haspopup="true"
              >
                <span class="sr-only">Open options</span>
                <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                  <path d="M10 3a1.5 1.5 0 110 3 1.5 1.5 0 010-3zM10 8.5a1.5 1.5 0 110 3 1.5 1.5 0 010-3zM11.5 15.5a1.5 1.5 0 10-3 0 1.5 1.5 0 003 0z" />
                </svg>
              </button>
            </div>
            <!-- Dropdown menu, show/hide based on menu state. -->
            @if(ticket.showMenu){
            <div
              class="absolute right-0 z-10 mt-2 w-56 origin-top-right rounded-md bg-background shadow-lg ring-1 ring-border ring-opacity-5 focus:outline-none"
              role="menu"
              aria-orientation="vertical"
              tabindex="-1"
            >
              <div class="py-1" role="none">
                <button (click)="toggleComponent(i)" class="flex px-4 py-2 text-sm text-secondaryforeground" role="menuitem" tabindex="-1" id="menu-{{ i }}-item-0">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M20.25 8.511c.884.284 1.5 1.128 1.5 2.097v4.286c0 1.136-.847 2.1-1.98 2.193-.34.027-.68.052-1.02.072v3.091l-3-3c-1.354 0-2.694-.055-4.02-.163a2.115 2.115 0 0 1-.825-.242m9.345-8.334a2.126 2.126 0 0 0-.476-.095 48.64 48.64 0 0 0-8.048 0c-1.131.094-1.976 1.057-1.976 2.192v4.286c0 .837.46 1.58 1.155 1.951m9.345-8.334V6.637c0-1.621-1.152-3.026-2.76-3.235A48.455 48.455 0 0 0 11.25 3c-2.115 0-4.198.137-6.24.402-1.608.209-2.76 1.614-2.76 3.235v6.226c0 1.621 1.152 3.026 2.76 3.235.577.075 1.157.14 1.74.194V21l4.155-4.155"
                    />
                  </svg>

                  <span class="hover:font-semibold">Répondre</span>
                </button>

                <button class="flex px-4 py-2 text-sm text-secondaryforeground" role="menuitem" tabindex="-1" id="menu-{{ i }}-item-1" (click)="inactiveTicket(i)">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M16.5 10.5V6.75a4.5 4.5 0 1 0-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 0 0 2.25-2.25v-6.75a2.25 2.25 0 0 0-2.25-2.25H6.75a2.25 2.25 0 0 0-2.25 2.25v6.75a2.25 2.25 0 0 0 2.25 2.25Z"
                    />
                  </svg>
                  <span class="hover:font-semibold">Clôturer</span>
                </button>
              </div>
            </div>
            <!-- Fin du menu déroulant -->
            }
          </div>
        </div>
      </div>
    </div>
    @if(ticket.showComponent){
    <div class="bg-background rounded-sm font-montserrat px-4 py-5 sm:px-6 mt-3">
      <app-support-message-admin [ticket]="ticket" (messageCreated)="handleMessageCreated()"></app-support-message-admin>
    </div>
    } }
  </div>
</div>
